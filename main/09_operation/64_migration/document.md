**ç¾åœ¨ã®ã‚¹ã‚­ãƒ¼ãƒï¼š**

![current-schema.png](./screenshots/current-schema.png)

**ç§»è¡Œå¾Œã®ã‚¹ã‚­ãƒ¼ãƒï¼š**

![new-schema.png](./screenshots/new-schema.png)

---

ã‚³ãƒ¼ãƒ‰ä¿®æ­£ã®ã¿ã§ã‚¹ã‚­ãƒ¼ãƒç§»è¡Œã®å¿…è¦ãŒãªã•ãã†ãªä»¶

æ­£è¦åŒ–å¾¹åº•ã—ã¦ãã‚ŒãŸéå»ã®è‡ªåˆ†æœ€é«˜ ğŸ¥²

**ä¸€å¿œç°¡æ˜“ç‰ˆã§é›°å›²æ°—ã¯ãƒãƒã‚´ãƒˆã—ã¦ãŠããƒ»ãƒ»ãƒ»ï¼ˆä»¥ä¸‹æ‰‹é †æ›¸ã¨ã—ã¾ã™ â†“ï¼‰**

---

# ç›®çš„

â—¯â—¯ ãªãƒ‹ãƒ¼ã‚ºã‚’å—ã‘ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¤‡æ•°ãƒšã‚¢ã¸æ‰€å±ã™ã‚‹æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ã€‚

ãã®ãŸã‚ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†ã€‚

# å•ã„åˆã‚ã›å…ˆ

| è²¬ä»»è€…   | ãƒ¯ã‚¤ã‚­ã‚­ãƒ»ä½ã‚€å¤«            |
| -------- | --------------------------- |
| é›»è©±ç•ªå· | 0120-444-444                |
| ãƒ¡ãƒ¼ãƒ«   | waikiki-sumuo@surf-tech.com |

# äºˆæƒ³æ‰€è¦æ™‚é–“

ç´„ 30 åˆ†ç¨‹åº¦

# æ¦‚è¦

Expand and contract pattern (â€») ã®ã‚¹ãƒ†ãƒƒãƒ—ã”ã¨ã«ã€Œå®Ÿè¡Œæ‰‹é †ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«åˆ—æŒ™ã—ãŸã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã„ãã¾ã™ã€‚

**(â€» [Expand and contract pattern](https://www.prisma.io/dataguide/types/relational/expand-and-contract-pattern))**

**Step1: æ–°ã—ã„ã‚¹ã‚­ãƒ¼ãƒã®å®Ÿè£…ã¨ãƒ‡ãƒ—ãƒ­ã‚¤**

**Step2: ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã‚’æ‹¡å¼µã™ã‚‹**

**Step3: ãƒ‡ãƒ¼ã‚¿ã‚’ç§»è¡Œã™ã‚‹**

**Step4: ãƒ†ã‚¹ãƒˆ**

**Step5: æ–°ã—ã„ã‚¹ã‚­ãƒ¼ãƒã‹ã‚‰èª­ã¿è¾¼ã¿ã‚’è¡Œã†ã‚ˆã†ã«åˆ‡ã‚Šæ›¿ãˆã‚‹**

**Step6: æ—§ã‚¹ã‚­ãƒ¼ãƒã¸ã®æ›¸ãè¾¼ã¿ã‚’åœæ­¢ã™ã‚‹**

**Step7: æ—§ã‚¹ã‚­ãƒ¼ãƒã®å‰Šé™¤**

# å®Ÿè¡Œæ‰‹é †

## å‰æ

### 1. é–‹å§‹å ±å‘Š

ã‚µãƒ¼ãƒ•ã‚£ãƒ³ã‚’è¾ã‚ã¦é™¸åœ°ã§å¾…æ©Ÿã™ã‚‹ãŸã‚ã€è²¬ä»»è€…ã¸ã®é–‹å§‹å ±å‘Šã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚

### 2. æœ¬ç•ªç’°å¢ƒã¸ã®æ¥ç¶šæ–¹æ³•

```bash
# SSHæ¥ç¶š
$ ssh -i ${key-file}.pem ${server-name}

# å¯¾è±¡ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¸ç§»å‹•
$ cd ${path}
```

## å®Ÿä½œæ¥­

### 0. å®Ÿè£…

Expand and contract pattern ã«åŸºã¥ãï¼‘ã‚¹ãƒ†ãƒƒãƒ—ãšã¤å®Ÿè£…ã‚’è¡Œãªã£ã¦ã„ã‚‹ã¨ä»®å®šã—ã¾ã™ã€‚

### 1. ï¼ˆãƒ‡ãƒ¼ã‚¿å¤‰æ›´ã‚’åŠ ãˆã‚‹å ´åˆï¼‰ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆ

```bash
# DBã‚µãƒ¼ãƒãƒ¼ï¼ˆè©³ç´°ãªã‚³ãƒãƒ³ãƒ‰ã¯è‡ªä¿¡ãªã—ãƒ»ãƒ»ãƒ»ï¼‰
$ pg_dump ${dbname} > ${dump-name}.dump
```

### 2. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ

```bash
# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒãƒ¼
$ npx prisma generate deploy
```

- **ã‚‚ã—ã‚‚å¤±æ•—ã—ãŸå ´åˆï¼š**

  1. ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’è¡Œã†

     ```bash
     # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒãƒ¼
     $ npx prisma migrate down ${n} --experimental
     ```

  2. ï¼ˆãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ãŸã„å ´åˆï¼‰ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰ DB ã‚’ãƒªã‚¹ãƒˆã‚¢

     ```bash
     # DBã‚µãƒ¼ãƒãƒ¼ï¼ˆè©³ç´°ãªã‚³ãƒãƒ³ãƒ‰ã¯è‡ªä¿¡ãªã—ãƒ»ãƒ»ãƒ»ï¼‰
     $ dropdb ${dbname}
     $ pg_restore -C ${dump-name}.dump
     ```

### 3. PrismaClient ã¸ã®ã‚¹ã‚­ãƒ¼ãƒåæ˜ 

```bash
# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒãƒ¼
$ npx prisma generate
```

### 4. ãƒ‡ãƒ¼ã‚¿ãŒæ›´æ–°ã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª

```bash
# DBã‚µãƒ¼ãƒãƒ¼
$ use ${table-name};
$ SHOW COLUMNS FROM ${table-name};
```

## çµ‚äº†

### å®Œäº†å ±å‘Šï¼ˆãŠã‚ã‚Šï¼‰

ã‚µãƒ¼ãƒ•ã‚£ãƒ³ã«æˆ»ã‚‹ãŸã‚çµ‚äº†å ±å‘Šã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚

# å‚ç…§è³‡æ–™

[Chapter 26. Backup and Restore](https://www.postgresql.org/docs/current/backup.html)
