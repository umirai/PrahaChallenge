# 問題回答

### 1. インデックスの仕組みを易しく説明
本の目次をイメージしよう。一冊の本の中から特定のトピックについて読みたい時、ページの先頭から順番に探すより目次から探した方が早いよね。DBのインデックスは、テーブルのカラムに対して付与する。テーブルスキャンする前にインデックスを使って、レコードを絞り込めるので、検索効率が良くなるんだよ。

### 2. Slow Query Logを調べる必要性
闇雲にインデックスをはることは、SQLアンチパターン「#12：インデックスショットガン」に相当。MENTORの原則に基づいて、効果的なインデックス管理を行うようにするべし。

- Measure(測定)
- Explain(解析)
- Nominate(指名)
- Test(テスト)
- Optimize(最適化)
- Rebuild(再構築)

インデックスを定義するにもメモリ領域が必要であること、不要なオーバーヘッド（Insert, Update, Delete時にインデックスが再構築されること）の増加などにより逆にパフォーマンスが悪化してしまうことなど、闇雲にインデックスをはれば早くなるというものではない。よって実際の数値を確認しながらの調査は必要。MySQLの公式リファレンスによると

>MySQL では利用可能な場合でもインデックスが使用されない場合があることに注意してください。この一例として、インデックスの使用によって、MySQL がテーブルの 30% を超えるレコードにアクセスする必要が生じる場合が挙げられます。

つまり100万件中30万件にヒットするクエリでは、インデックスをつかわなかったり、そういう場面が他にもあるということを頭に置いておく。

### 3. カーディナリティとは
多重度。一カラムに何種類程度の値が格納されているか。YESとNOだけを切り替えるフラグならカーディナリティが2で、低い。逆にカーディナリティが高いほどインデックスが有効。

### 4. カバリングインデックスとは
クエリの処理に必要なデータを全て含んでいるインデックスのこと。当該のインデックスのスキャンのみで、テーブルにアクセスする必要がなければ、そのインデックスはカバリングインデックス。

---

**Slow Query Log 確認手順**

1. 設定の確認

```sql
-- ON or OFFを確認
SHOW VARIABLES LIKE 'slow_query%';

-- 何秒以上のクエリを出力するかを確認
SHOW VARIABLES LIKE 'long%';
```

2. 設定の変更

```sql
-- sloq query log の有効化
set global slow_query_log = ON;

-- /tmp/slow.log ファイルへ出力する
set global slow_query_log_file='/tmp/slow.log';

-- 1秒以上のクエリを出力する
set global long_query_time = 1;

-- 変更内容を確認（反映されていなかったら一度exitしてみるとよい）
SHOW VARIABLES LIKE 'slow_query%';
SHOW VARIABLES LIKE 'long%';
```

- [スロークエリの確認方法](https://ptune.jp/tech/how-to-check-mysql-slow-query/)
- [Mysql slow queryの設定と解析方法](https://masayuki14.hatenablog.com/entry/20120704/1341360260)